<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÑúÎπÑÏä§ Ï≤òÎ¶¨ - Ï†úÌíàÎ≥Ñ, ÏÑºÌÑ∞Î≥Ñ ÌòÑÌô©</title>
    
    <!-- 
    ====================================================================
    Î¶¨Ìå©ÌÜ†ÎßÅ Î≤ÑÏ†Ñ - Ïô∏Î∂Ä JSON Îç∞Ïù¥ÌÑ∞ Î°úÎî©
    ====================================================================
    ÌååÏùº Íµ¨Ï°∞:
    üìÅ dashboard/
      ‚îú‚îÄ‚îÄ processing_dashboard.html  (Ïù¥ ÌååÏùº)
      ‚îú‚îÄ‚îÄ chart.umd.js
      ‚îú‚îÄ‚îÄ manifest.json
      ‚îî‚îÄ‚îÄ üìÅ data/
          ‚îú‚îÄ‚îÄ 2026-01-processing.json
          ‚îî‚îÄ‚îÄ ...
    
    ‚ö†Ô∏è pako.min.jsÎäî Îçî Ïù¥ÏÉÅ ÌïÑÏöî ÏóÜÏäµÎãàÎã§!
       Îç∞Ïù¥ÌÑ∞Í∞Ä Ïô∏Î∂Ä JSONÏúºÎ°ú Î∂ÑÎ¶¨ÎêòÏñ¥ gzip ÏïïÏ∂ïÏù¥ Î∂àÌïÑÏöîÌï©ÎãàÎã§.
    ====================================================================
    -->
    
    <script src="chart.umd.js"></script>
    <script>if(typeof Chart==='undefined')document.write('<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"><\/script>');</script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", "ÎßëÏùÄ Í≥†Îîï", "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        
        .main-nav {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 2px solid #F1F5F9;
            flex-wrap: wrap;
        }
        
        .nav-button {
            padding: 14px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            border: 2px solid #667EEA;
            background: white;
            color: #667EEA;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-button:hover {
            background: #667EEA;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .nav-button.active {
            background: #667EEA;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        h1 {
            font-size: 36px;
            font-weight: 800;
            color: #667EEA;
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: #64748B;
            font-size: 15px;
            margin-bottom: 24px;
        }

        /* ===== Í∏∞Í∞Ñ ÏÑ†ÌÉù ===== */
        .period-selector-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding: 16px 20px;
            background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);
            border-radius: 12px;
            border: 2px solid #C7D2FE;
        }
        .period-selector-label {
            font-size: 14px;
            font-weight: 700;
            color: #4338CA;
        }
        .period-selector {
            padding: 10px 36px 10px 16px;
            border-radius: 8px;
            border: 2px solid #A5B4FC;
            background: white;
            font-size: 15px;
            font-weight: 600;
            color: #1E293B;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%234338CA' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            transition: all 0.2s;
        }
        .period-selector:hover { border-color: #667EEA; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2); }
        .period-selector:focus { outline: none; border-color: #667EEA; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15); }
        .period-info { font-size: 13px; color: #6366F1; font-weight: 500; }

        /* ===== Î°úÎî©/ÏóêÎü¨ ===== */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.85);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 16px;
        }
        .loading-overlay.show { display: flex; }
        .loading-spinner {
            width: 48px; height: 48px;
            border: 4px solid #E2E8F0;
            border-top-color: #667EEA;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 16px; font-weight: 600; color: #667EEA; }
        .error-banner {
            display: none;
            padding: 16px 24px;
            background: #FEF2F2;
            border: 2px solid #FCA5A5;
            border-radius: 12px;
            margin-bottom: 24px;
            color: #991B1B;
            font-size: 14px;
            font-weight: 600;
        }
        .error-banner.show { display: block; }

        /* Î°úÏª¨ ÌååÏùº ÏßÅÏ†ë Î°úÎî© Ìå®ÎÑê */
        .file-fallback {
            display: none;
            padding: 24px;
            background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
            border: 2px solid #F59E0B;
            border-radius: 16px;
            margin-bottom: 24px;
        }
        .file-fallback.show { display: block; }
        .file-fallback h3 { font-size: 16px; font-weight: 700; color: #92400E; margin-bottom: 8px; }
        .file-fallback p { font-size: 13px; color: #78350F; margin-bottom: 16px; line-height: 1.6; }
        .file-fallback .fb-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
        .file-fallback .fb-label { font-size: 13px; font-weight: 700; color: #92400E; min-width: 120px; }
        .file-fallback .fb-btn {
            padding: 8px 20px; border-radius: 8px; border: 2px solid #D97706;
            background: white; color: #92400E; font-weight: 600; font-size: 13px;
            cursor: pointer; font-family: inherit; transition: all 0.2s;
        }
        .file-fallback .fb-btn:hover { background: #FEF3C7; }
        .file-fallback .fb-btn.loaded { background: #D1FAE5; border-color: #059669; color: #065F46; }
        .file-fallback .fb-status { font-size: 12px; color: #059669; font-weight: 600; }
        .file-fallback input[type="file"] { display: none; }
        
        .filters-section {
            padding: 20px 0;
            margin-bottom: 20px;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.9em;
        }
        
        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9em;
            transition: border-color 0.3s;
            cursor: pointer;
            background: white;
        }
        
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filter-group select:hover {
            border-color: #764ba2;
        }
        
        .reset-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .reset-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220,53,69,0.3);
        }
        
        .dashboard-section {
            margin-top: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-card h3 {
            font-size: 0.8em;
            opacity: 0.9;
            margin-bottom: 6px;
        }
        
        .stat-card .value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .stat-card p {
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        .detailed-stats-section {
            margin-bottom: 30px;
        }
        
        .detailed-stats-section h2 {
            color: #333;
            font-size: 1.4em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .center-group {
            margin-bottom: 25px;
        }
        
        .center-boxes-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .center-main-box {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-top: 4px solid #667eea;
        }
        
        .center-main-box h3 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
        }
        
        .center-main-box .total-count {
            font-size: 3em;
            font-weight: bold;
            color: #764ba2;
            text-align: center;
            margin: 20px 0;
        }
        
        .center-main-box .share-rate {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .center-main-box .share-label {
            font-size: 0.95em;
            color: #666;
            margin-bottom: 8px;
        }
        
        .center-main-box .share-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .repair-type-box {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-top: 4px solid #764ba2;
        }
        
        .repair-type-box h4 {
            color: #764ba2;
            font-size: 1.1em;
            margin-bottom: 20px;
            font-weight: 700;
            text-align: center;
        }
        
        .process-type-box {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-top: 4px solid #17a2b8;
        }
        
        .process-type-box h4 {
            color: #17a2b8;
            font-size: 1.1em;
            margin-bottom: 20px;
            font-weight: 700;
            text-align: center;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 12px;
            margin-bottom: 6px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.95em;
        }
        
        .stat-item-label { color: #555; font-weight: 500; }
        .stat-item-values { text-align: right; }
        .stat-item-count { font-weight: bold; color: #333; }
        .stat-item-percent { font-size: 0.85em; color: #667eea; margin-left: 8px; }
        
        .chart-section {
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }
        
        .chart-header h2 {
            color: #333;
            font-size: 1.3em;
        }
        
        .toggle-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .toggle-btn:hover {
            background: #764ba2;
            transform: scale(1.05);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
        }
        
        .chart-container.hidden {
            display: none;
        }
        
        .payment-charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }
        
        .payment-chart-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .payment-chart-item h3 {
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .payment-chart-container {
            position: relative;
            height: 300px;
        }
        
        .product-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .product-stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #28a745;
        }
        
        .product-stat-card h3 {
            color: #28a745;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .repair-breakdown { margin-top: 10px; }
        
        .repair-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            margin-bottom: 5px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #28a745;
        }
        
        .sub-stat-label { font-size: 0.9em; color: #666; font-weight: 500; }
        .sub-stat-value { font-size: 1em; font-weight: bold; color: #333; }
        .sub-stat-percent { font-size: 0.85em; color: #667eea; margin-left: 8px; }
        
        .sub-stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f8f9fa;
        }
        
        @media (max-width: 1200px) {
            .center-boxes-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            .main-nav { flex-direction: column; }
            .filters-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .product-stats-grid, .payment-charts-grid { grid-template-columns: 1fr; }
            .chart-header { flex-direction: column; gap: 10px; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <!-- Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
    </div>

    <div class="container">
        <div class="main-nav">
            <a href="index.html" class="nav-button">üìä ÏÑúÎπÑÏä§ Ï†ëÏàò ÎπÑÍµê Î∂ÑÏÑù</a>
            <a href="symptom_analysis.html" class="nav-button">üîç Î¨∏ÏùòÎÇ¥Ïö© Ï¶ùÏÉÅ Î∂ÑÏÑù</a>
            <a href="processing_dashboard.html" class="nav-button active">üìã Ï≤òÎ¶¨Í±¥ Î∂ÑÏÑù</a>
        </div>
        
        <h1>ÏÑúÎπÑÏä§ Ï≤òÎ¶¨ - Ï†úÌíàÎ≥Ñ, ÏÑºÌÑ∞Î≥Ñ ÌòÑÌô©</h1>
        <p class="subtitle" id="subtitleText">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</p>

        <!-- üÜï Í∏∞Í∞Ñ ÏÑ†ÌÉù ÎìúÎ°≠Îã§Ïö¥ -->
        <div class="period-selector-container">
            <span class="period-selector-label">üìÖ Î∂ÑÏÑù Í∏∞Í∞Ñ:</span>
            <select class="period-selector" id="periodSelector">
                <option value="">Î°úÎî© Ï§ë...</option>
            </select>
            <span class="period-info" id="periodInfo"></span>
        </div>

        <!-- ÏóêÎü¨ Î∞∞ÎÑà -->
        <div class="error-banner" id="errorBanner"></div>

        <!-- üÜï Î°úÏª¨ ÌååÏùº ÏßÅÏ†ë Î°úÎî© Ìå®ÎÑê -->
        <div class="file-fallback" id="fileFallback">
            <h3>üìÅ Î°úÏª¨ ÌååÏùº Î™®Îìú</h3>
            <p>Î°úÏª¨(file://)ÏóêÏÑúÎäî ÏûêÎèô Î°úÎî©Ïù¥ Î∂àÍ∞ÄÌï©ÎãàÎã§. ÏïÑÎûò Î≤ÑÌäºÏúºÎ°ú JSON ÌååÏùºÏùÑ ÏßÅÏ†ë ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.<br>
            ÎòêÎäî Î°úÏª¨ ÏÑúÎ≤Ñ: <code style="background:#FEF3C7;padding:2px 6px;border-radius:4px;font-size:12px;">python -m http.server 8000</code> ‚Üí <code style="background:#FEF3C7;padding:2px 6px;border-radius:4px;font-size:12px;">http://localhost:8000</code></p>
            <div class="fb-row">
                <span class="fb-label">‚ë† manifest.json</span>
                <button class="fb-btn" id="fbManifestBtn" onclick="document.getElementById('fbManifestInput').click()">ÌååÏùº ÏÑ†ÌÉù</button>
                <span class="fb-status" id="fbManifestStatus"></span>
                <input type="file" id="fbManifestInput" accept=".json" onchange="handleLocalManifest(this)">
            </div>
            <div class="fb-row" id="fbDataRow" style="display:none;">
                <span class="fb-label">‚ë° Îç∞Ïù¥ÌÑ∞ JSON</span>
                <button class="fb-btn" id="fbDataBtn" onclick="document.getElementById('fbDataInput').click()">ÌååÏùº ÏÑ†ÌÉù</button>
                <span class="fb-status" id="fbDataStatus"></span>
                <input type="file" id="fbDataInput" accept=".json" onchange="handleLocalData(this)">
            </div>
        </div>
        
        <div class="filters-section" id="filtersSection" style="display: none;">
            <div class="filters-grid" id="filtersGrid"></div>
            <div style="text-align: center; margin-top: 10px;">
                <button class="reset-btn" onclick="resetFilters()">üîÑ ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî</button>
            </div>
        </div>
        
        <div class="dashboard-section" id="dashboardSection" style="display: none;">
            <div class="stats-grid" id="statsGrid"></div>
            
            <div class="detailed-stats-section">
                <h2>üè¢ ÏÑºÌÑ∞Ïú†ÌòïÏÉÅÏÑ∏Î≥Ñ ÌÜµÍ≥Ñ</h2>
                <div id="centerGroupsContainer"></div>
            </div>
            
            <div class="chart-section">
                <div class="chart-card">
                    <div class="chart-header">
                        <h2>üìà Ï≤òÎ¶¨ÏõîÎ≥Ñ Í±¥Ïàò Ï∂îÏù¥</h2>
                        <button class="toggle-btn" onclick="toggleChart('monthlyChart')">Ï∞®Ìä∏ Ïà®Í∏∞Í∏∞</button>
                    </div>
                    <div class="chart-container" id="monthlyChartContainer">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h2>üè™ Ï†úÌíàÎ≥Ñ ÏÑúÎπÑÏä§ ÌòÑÌô© (ÏÉÅÏúÑ 15Í∞ú)</h2>
                        <button class="toggle-btn" onclick="toggleChart('productChart')">Ï∞®Ìä∏ Ïà®Í∏∞Í∏∞</button>
                    </div>
                    <div class="chart-container" id="productChartContainer">
                        <canvas id="productChart"></canvas>
                    </div>
                    <div class="detailed-stats-section" style="margin-top: 30px;">
                        <h2 style="font-size: 1.2em;">üì¶ ÏÉÅÏúÑ 8Í∞ú Ï†úÌíà ÏÉÅÏÑ∏ ÌÜµÍ≥Ñ</h2>
                        <div class="product-stats-grid" id="productStatsGrid"></div>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h2>üí∞ Ïú†Î¨¥ÏÉÅ Íµ¨Î∂Ñ (ÏÑºÌÑ∞Ïú†ÌòïÏÉÅÏÑ∏Î≥Ñ)</h2>
                        <button class="toggle-btn" onclick="togglePaymentCharts()">Ï∞®Ìä∏ Ïà®Í∏∞Í∏∞</button>
                    </div>
                    <div id="paymentChartsContainer">
                        <div class="payment-charts-grid" id="paymentChartsGrid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ====================================================================
    // DataLoader - Í≥µÌÜµ Ïô∏Î∂Ä JSON Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÌÅ¥ÎûòÏä§
    // ====================================================================
    var DataLoader = {
        manifest: null,
        cache: {},
        dataType: 'processing',
        isLocal: location.protocol === 'file:',
        _storagePrefix: '__dash_processing_',

        showLoading: function() {
            document.getElementById('loadingOverlay').classList.add('show');
        },
        hideLoading: function() {
            document.getElementById('loadingOverlay').classList.remove('show');
        },
        showError: function(msg) {
            var banner = document.getElementById('errorBanner');
            banner.textContent = '‚ö†Ô∏è ' + msg;
            banner.classList.add('show');
        },
        hideError: function() {
            document.getElementById('errorBanner').classList.remove('show');
        },

        // IndexedDB ÎåÄÏö©Îüâ Ï∫êÏã±
        _dbName: 'DashCache_processing',
        _dbVer: 1,
        _openDB: function() {
            var self = this;
            return new Promise(function(resolve, reject) {
                var req = indexedDB.open(self._dbName, self._dbVer);
                req.onupgradeneeded = function(e) { e.target.result.createObjectStore('cache'); };
                req.onsuccess = function(e) { resolve(e.target.result); };
                req.onerror = function() { reject(req.error); };
            });
        },
        saveToIDB: async function(key, value) {
            try {
                var db = await this._openDB();
                return new Promise(function(resolve) {
                    var tx = db.transaction('cache', 'readwrite');
                    tx.objectStore('cache').put(value, key);
                    tx.oncomplete = function() { resolve(true); };
                    tx.onerror = function() { resolve(false); };
                });
            } catch(e) { return false; }
        },
        loadFromIDB: async function(key) {
            try {
                var db = await this._openDB();
                return new Promise(function(resolve) {
                    var tx = db.transaction('cache', 'readonly');
                    var req = tx.objectStore('cache').get(key);
                    req.onsuccess = function() { resolve(req.result || null); };
                    req.onerror = function() { resolve(null); };
                });
            } catch(e) { return null; }
        },

        loadManifest: async function() {
            if (this.isLocal) {
                document.getElementById('fileFallback').classList.add('show');
                return null;
            }
            try {
                var response = await fetch('manifest.json?t=' + Date.now());
                if (!response.ok) throw new Error('manifest.jsonÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                this.manifest = await response.json();
                return this.manifest;
            } catch (e) {
                this.showError('manifest.json Î°úÎìú Ïã§Ìå®: ' + e.message);
                return null;
            }
        },

        loadPeriod: async function(periodId) {
            var cacheKey = periodId + '_' + this.dataType;
            if (this.cache[cacheKey]) return this.cache[cacheKey];
            
            if (this.isLocal) {
                document.getElementById('fbDataRow').style.display = 'flex';
                document.getElementById('fbDataStatus').textContent = '‚Üê ' + periodId + '-' + this.dataType + '.json ÏÑ†ÌÉù';
                return null;
            }
            
            this.showLoading();
            this.hideError();
            
            try {
                var periodMeta = this.manifest.periods.find(function(p) { return p.id === periodId; });
                var url;
                if (periodMeta && periodMeta.files && periodMeta.files[this.dataType]) {
                    url = periodMeta.files[this.dataType] + '?t=' + Date.now();
                } else {
                    url = 'data/' + periodId + '-' + this.dataType + '.json?t=' + Date.now();
                }
                
                var response = await fetch(url);
                if (!response.ok) throw new Error(url + 'ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                
                var data = await response.json();
                this.cache[cacheKey] = data;
                this.hideLoading();
                return data;
            } catch (e) {
                this.hideLoading();
                this.showError('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: ' + e.message);
                return null;
            }
        },

        populatePeriodSelector: function() {
            var selector = document.getElementById('periodSelector');
            selector.innerHTML = '';
            
            if (!this.manifest || !this.manifest.periods || this.manifest.periods.length === 0) {
                selector.innerHTML = '<option value="">ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</option>';
                return;
            }

            var periods = this.manifest.periods.slice().sort(function(a, b) {
                return b.id.localeCompare(a.id);
            });

            periods.forEach(function(period) {
                var option = document.createElement('option');
                option.value = period.id;
                option.textContent = period.label || period.id;
                selector.appendChild(option);
            });
        }
    };

    // Î°úÏª¨ ÌååÏùº Î°úÎî© Ìï∏Îì§Îü¨ (localStorage Ï∫êÏã±)
    function handleLocalManifest(input) {
        if (!input.files[0]) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                DataLoader.manifest = JSON.parse(e.target.result);
                try { localStorage.setItem(DataLoader._storagePrefix + 'manifest', e.target.result); } catch(x) {}
                DataLoader.populatePeriodSelector();
                document.getElementById('fbManifestBtn').classList.add('loaded');
                document.getElementById('fbManifestBtn').textContent = '‚úÖ Î°úÎìú ÏôÑÎ£å';
                document.getElementById('fbManifestStatus').textContent = DataLoader.manifest.periods.length + 'Í∞ú Í∏∞Í∞Ñ';
                document.getElementById('fbDataRow').style.display = 'flex';
                DataLoader.hideError();
            } catch (err) {
                DataLoader.showError('manifest.json ÌååÏã± Ïò§Î•ò: ' + err.message);
            }
        };
        reader.readAsText(input.files[0]);
    }

    function handleLocalData(input) {
        if (!input.files[0]) return;
        var reader = new FileReader();
        reader.onload = async function(e) {
            try {
                var data = JSON.parse(e.target.result);
                var periodId = document.getElementById('periodSelector').value;
                var cacheKey = periodId + '_' + DataLoader.dataType;
                DataLoader.cache[cacheKey] = data;
                // IndexedDBÏóê Ï∫êÏã± (ÎåÄÏö©Îüâ ÏßÄÏõê)
                var saved = await DataLoader.saveToIDB(cacheKey, data);
                if (!saved) {
                    console.warn('[Ï∫êÏãú] IndexedDB Ï†ÄÏû• Ïã§Ìå® - Îã§Ïùå Ï†ëÏÜç Ïãú Îç∞Ïù¥ÌÑ∞ Ïû¨Î°úÎìú ÌïÑÏöî');
                } else {
                    console.log('[Ï∫êÏãú] IndexedDB Ï†ÄÏû• ÏôÑÎ£å: ' + cacheKey);
                }
                document.getElementById('fbDataBtn').classList.add('loaded');
                document.getElementById('fbDataBtn').textContent = '‚úÖ Î°úÎìú ÏôÑÎ£å';
                document.getElementById('fbDataStatus').textContent = input.files[0].name + (saved ? ' (Ï∫êÏãúÎê®)' : ' (Ï∫êÏãú Ïã§Ìå®)');
                await changePeriod(periodId);
            } catch (err) {
                DataLoader.showError('Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò: ' + err.message);
            }
        };
        reader.readAsText(input.files[0]);
    }

    // ====================================================================
    // App - Ï≤òÎ¶¨Í±¥ Î∂ÑÏÑù ÎåÄÏãúÎ≥¥Îìú Î°úÏßÅ (Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ)
    // ====================================================================
    let rawData = [];
    let filteredData = [];
    let charts = {};
    
    // üÜï Í∏∞Í∞Ñ Î≥ÄÍ≤Ω - Í∏∞Ï°¥ decompressData() ÎåÄÏ≤¥
    async function changePeriod(periodId) {
        var loaded = await DataLoader.loadPeriod(periodId);
        if (!loaded) return;
        
        // JSON Íµ¨Ï°∞Ïóê Îî∞Îùº rawData Îß§Ìïë
        if (loaded.rows) {
            rawData = loaded.rows;
        } else if (Array.isArray(loaded)) {
            rawData = loaded;
        } else {
            rawData = [];
        }
        
        filteredData = [...rawData];
        
        // Î∂ÄÏ†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
        var periodMeta = DataLoader.manifest.periods.find(function(p) { return p.id === periodId; });
        document.getElementById('subtitleText').textContent = 
            (periodMeta ? periodMeta.label : periodId) + ' Ï≤òÎ¶¨ Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù';
        
        var info = document.getElementById('periodInfo');
        if (periodMeta && periodMeta.generated) {
            info.textContent = 'ÏÉùÏÑ±Ïùº: ' + periodMeta.generated;
        }
        
        // ÎåÄÏãúÎ≥¥Îìú ÌëúÏãú
        document.getElementById('filtersSection').style.display = 'block';
        document.getElementById('dashboardSection').style.display = 'block';
        
        initializeDashboard();
    }
    
    function initializeDashboard() {
        createFilters();
        updateDashboard();
    }
    
    function createFilters() {
        const filtersGrid = document.getElementById('filtersGrid');
        filtersGrid.innerHTML = '';
        
        const filterFields = [
            { key: 'Ï†úÌíàÎ™Ö', label: 'Ï†úÌíàÎ≥Ñ' },
            { key: 'ÏÑºÌÑ∞Íµ¨Î∂Ñ', label: 'ÏÑºÌÑ∞Ïú†ÌòïÎ≥Ñ' },
            { key: 'ÏÑºÌÑ∞Íµ¨Î∂Ñ2', label: 'ÏÑºÌÑ∞Ïú†ÌòïÏÉÅÏÑ∏' },
            { key: 'ÏàòÎ¶¨', label: 'ÏàòÎ¶¨Ïú†ÌòïÎ≥Ñ' },
            { key: 'Ï≤òÎ¶¨Íµ¨Î∂Ñ', label: 'Ï≤òÎ¶¨Íµ¨Î∂Ñ' }
        ];
        
        filterFields.forEach(field => {
            const values = [...new Set(rawData.map(row => row[field.key]).filter(v => v != null && v != 'None'))].sort();
            
            const filterDiv = document.createElement('div');
            filterDiv.className = 'filter-group';
            filterDiv.innerHTML = `
                <label>${field.label}</label>
                <select id="filter_${field.key}" onchange="applyFilters()">
                    <option value="">Ï†ÑÏ≤¥ (${values.length}Í∞ú)</option>
                    ${values.map(v => `<option value="${v}">${v}</option>`).join('')}
                </select>
            `;
            filtersGrid.appendChild(filterDiv);
        });
    }
    
    function applyFilters() {
        filteredData = rawData.filter(row => {
            const filters = document.querySelectorAll('[id^="filter_"]');
            for (let filter of filters) {
                const key = filter.id.replace('filter_', '');
                const value = filter.value;
                if (value && row[key] != value) return false;
            }
            return true;
        });
        
        updateDashboard();
    }
    
    function resetFilters() {
        document.querySelectorAll('[id^="filter_"]').forEach(select => {
            select.value = '';
        });
        filteredData = [...rawData];
        updateDashboard();
    }
    
    function updateDashboard() {
        updateStats();
        updateCenterDetailedStats();
        updateCharts();
        updateProductDetailedStats();
    }
    
    function updateStats() {
        const statsGrid = document.getElementById('statsGrid');
        
        const totalCount = filteredData.reduce((sum, row) => sum + (row['Í±¥Ïàò'] || 0), 0);
        const uniqueProducts = new Set(filteredData.map(row => row['Ï†úÌíàÎ™Ö']).filter(v => v != null && v != 'None')).size;
        const uniqueCenters = new Set(filteredData.map(row => row['Ïù¥Í¥ÄÏ≤ò']).filter(v => v != null && v != 'None')).size;
        const avgPerCenter = uniqueCenters > 0 ? Math.round(totalCount / uniqueCenters) : 0;
        
        statsGrid.innerHTML = `
            <div class="stat-card">
                <h3>Ï¥ù Ï≤òÎ¶¨ Í±¥Ïàò</h3>
                <div class="value">${totalCount.toLocaleString()}</div>
                <p>Í±¥</p>
            </div>
            <div class="stat-card">
                <h3>Ï†úÌíà Ï¢ÖÎ•ò</h3>
                <div class="value">${uniqueProducts}</div>
                <p>Í∞ú</p>
            </div>
            <div class="stat-card">
                <h3>ÏÑúÎπÑÏä§ ÏÑºÌÑ∞</h3>
                <div class="value">${uniqueCenters}</div>
                <p>Í∞úÏÜå</p>
            </div>
            <div class="stat-card">
                <h3>ÏÑºÌÑ∞Îãπ ÌèâÍ∑†</h3>
                <div class="value">${avgPerCenter.toLocaleString()}</div>
                <p>Í±¥</p>
            </div>
        `;
    }
    
    function updateCenterDetailedStats() {
        const container = document.getElementById('centerGroupsContainer');
        
        const totalCount = filteredData.reduce((sum, row) => sum + (row['Í±¥Ïàò'] || 0), 0);
        const centerTypeDetails = {};
        
        filteredData.forEach(row => {
            const centerType = row['ÏÑºÌÑ∞Íµ¨Î∂Ñ2'] || 'ÎØ∏Î∂ÑÎ•ò';
            const repairType = row['ÏàòÎ¶¨'] || 'ÎØ∏Î∂ÑÎ•ò';
            const processType = row['Ï≤òÎ¶¨Íµ¨Î∂Ñ'] || 'ÎØ∏Î∂ÑÎ•ò';
            const count = row['Í±¥Ïàò'] || 0;
            
            if (!centerTypeDetails[centerType]) {
                centerTypeDetails[centerType] = { totalCount: 0, repairTypes: {}, processTypes: {} };
            }
            
            centerTypeDetails[centerType].totalCount += count;
            centerTypeDetails[centerType].repairTypes[repairType] = 
                (centerTypeDetails[centerType].repairTypes[repairType] || 0) + count;
            centerTypeDetails[centerType].processTypes[processType] = 
                (centerTypeDetails[centerType].processTypes[processType] || 0) + count;
        });
        
        const orderMap = {'ÏÑ§ÏπòÎ≤ïÏù∏': 1, 'ÏùºÎ∞òÏ†ê': 2, 'ÏßÅÏòÅÏ†ê': 3};
        const sortedEntries = Object.entries(centerTypeDetails)
            .sort((a, b) => (orderMap[a[0]] || 99) - (orderMap[b[0]] || 99));
        
        let html = '';
        
        sortedEntries.forEach(([centerType, data]) => {
            const centerPercent = totalCount > 0 ? (data.totalCount / totalCount * 100).toFixed(1) : 0;
            
            const sortedRepairs = Object.entries(data.repairTypes).sort((a, b) => b[1] - a[1]);
            let repairHtml = '';
            sortedRepairs.forEach(([repairType, repairCount]) => {
                const repairPercent = data.totalCount > 0 ? (repairCount / data.totalCount * 100).toFixed(1) : 0;
                repairHtml += `
                    <div class="stat-item">
                        <span class="stat-item-label">${repairType}</span>
                        <span class="stat-item-values">
                            <span class="stat-item-count">${repairCount.toLocaleString()}Í±¥</span>
                            <span class="stat-item-percent">${repairPercent}%</span>
                        </span>
                    </div>
                `;
            });
            
            const sortedProcess = Object.entries(data.processTypes).sort((a, b) => b[1] - a[1]);
            let processHtml = '';
            sortedProcess.forEach(([processType, processCount]) => {
                const processPercent = data.totalCount > 0 ? (processCount / data.totalCount * 100).toFixed(1) : 0;
                processHtml += `
                    <div class="stat-item">
                        <span class="stat-item-label">${processType}</span>
                        <span class="stat-item-values">
                            <span class="stat-item-count">${processCount.toLocaleString()}Í±¥</span>
                            <span class="stat-item-percent">${processPercent}%</span>
                        </span>
                    </div>
                `;
            });
            
            html += `
                <div class="center-group">
                    <div class="center-boxes-grid">
                        <div class="center-main-box">
                            <h3>${centerType}</h3>
                            <div class="total-count">${data.totalCount.toLocaleString()}Í±¥</div>
                            <div class="share-rate">
                                <div class="share-label">Ï†ÑÏ≤¥ ÎåÄÎπÑ Ï†êÏú†Ïú®</div>
                                <div class="share-value">${centerPercent}%</div>
                            </div>
                        </div>
                        <div class="repair-type-box">
                            <h4>ÏàòÎ¶¨Ïú†ÌòïÎ≥Ñ Í±¥Ïàò</h4>
                            ${repairHtml}
                        </div>
                        <div class="process-type-box">
                            <h4>Ï≤òÎ¶¨Íµ¨Î∂ÑÎ≥Ñ Í±¥Ïàò</h4>
                            ${processHtml}
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function updateCharts() {
        updateMonthlyChart();
        updateProductChart();
        updatePaymentChartsByCenterType();
    }
    
    function updateMonthlyChart() {
        const dataExcludeCancel = filteredData.filter(row => row['ÏàòÎ¶¨'] !== 'Ï∑®ÏÜå');
        const monthlyData = {};
        dataExcludeCancel.forEach(row => {
            const month = row['Ï≤òÎ¶¨Ïõî'] || 'ÎØ∏Î∂ÑÎ•ò';
            monthlyData[month] = (monthlyData[month] || 0) + (row['Í±¥Ïàò'] || 0);
        });
        
        const labels = Object.keys(monthlyData).sort();
        const values = labels.map(label => monthlyData[label]);
        
        if (charts.monthly) charts.monthly.destroy();
        
        const ctx = document.getElementById('monthlyChart').getContext('2d');
        charts.monthly = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ï≤òÎ¶¨ Í±¥Ïàò',
                    data: values,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: true, position: 'top' } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }
    
    function updateProductChart() {
        const dataExcludeCancel = filteredData.filter(row => row['ÏàòÎ¶¨'] !== 'Ï∑®ÏÜå');
        const productData = {};
        dataExcludeCancel.forEach(row => {
            const product = row['Ï†úÌíàÎ™Ö'] || 'ÎØ∏Î∂ÑÎ•ò';
            productData[product] = (productData[product] || 0) + (row['Í±¥Ïàò'] || 0);
        });
        
        const sorted = Object.entries(productData).sort((a, b) => b[1] - a[1]).slice(0, 15);
        const labels = sorted.map(item => item[0]);
        const values = sorted.map(item => item[1]);
        
        if (charts.product) charts.product.destroy();
        
        const ctx = document.getElementById('productChart').getContext('2d');
        charts.product = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ÏÑúÎπÑÏä§ Í±¥Ïàò',
                    data: values,
                    backgroundColor: 'rgba(102, 126, 234, 0.8)',
                    borderColor: '#667eea',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true } }
            }
        });
    }
    
    function updatePaymentChartsByCenterType() {
        const paymentChartsGrid = document.getElementById('paymentChartsGrid');
        const dataExcludeCancel = filteredData.filter(row => row['ÏàòÎ¶¨'] !== 'Ï∑®ÏÜå');
        const centerTypes = ['Ï†ÑÏ≤¥', ...new Set(dataExcludeCancel.map(row => row['ÏÑºÌÑ∞Íµ¨Î∂Ñ2']).filter(v => v != null && v != 'None'))];
        
        let html = '';
        const colors = [
            'rgba(102, 126, 234, 0.8)',
            'rgba(118, 75, 162, 0.8)',
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 206, 86, 0.8)'
        ];
        
        centerTypes.forEach((centerType, index) => {
            html += `
                <div class="payment-chart-item">
                    <h3>${centerType}</h3>
                    <div class="payment-chart-container">
                        <canvas id="paymentChart_${index}"></canvas>
                    </div>
                </div>
            `;
        });
        
        paymentChartsGrid.innerHTML = html;
        
        centerTypes.forEach((centerType, index) => {
            const data = centerType === 'Ï†ÑÏ≤¥' 
                ? dataExcludeCancel 
                : dataExcludeCancel.filter(row => row['ÏÑºÌÑ∞Íµ¨Î∂Ñ2'] === centerType);
            
            const paymentData = {};
            data.forEach(row => {
                const payment = row['Ïú†Î¨¥ÏÉÅÍµ¨Î∂Ñ'] || 'ÎØ∏Î∂ÑÎ•ò';
                paymentData[payment] = (paymentData[payment] || 0) + (row['Í±¥Ïàò'] || 0);
            });
            
            const labels = Object.keys(paymentData).sort().map(label => {
                if (label === 'N') return 'Î¨¥ÏÉÅÍ±¥';
                if (label === 'Y') return 'Ïú†ÏÉÅÍ±¥';
                return label;
            });
            const values = Object.keys(paymentData).sort().map(label => paymentData[label]);
            
            if (charts[`payment_${index}`]) charts[`payment_${index}`].destroy();
            
            const ctx = document.getElementById(`paymentChart_${index}`).getContext('2d');
            charts[`payment_${index}`] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderColor: '#fff',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        });
    }
    
    function updateProductDetailedStats() {
        const productStatsGrid = document.getElementById('productStatsGrid');
        const dataExcludeCancel = filteredData.filter(row => row['ÏàòÎ¶¨'] !== 'Ï∑®ÏÜå');
        const productDetails = {};
        
        dataExcludeCancel.forEach(row => {
            const product = row['Ï†úÌíàÎ™Ö'] || 'ÎØ∏Î∂ÑÎ•ò';
            const centerType = row['ÏÑºÌÑ∞Íµ¨Î∂Ñ2'] || 'ÎØ∏Î∂ÑÎ•ò';
            const repairType = row['ÏàòÎ¶¨'] || 'ÎØ∏Î∂ÑÎ•ò';
            const count = row['Í±¥Ïàò'] || 0;
            
            if (!productDetails[product]) {
                productDetails[product] = { totalCount: 0, centerTypes: {}, repairTypes: {} };
            }
            
            productDetails[product].totalCount += count;
            productDetails[product].centerTypes[centerType] = 
                (productDetails[product].centerTypes[centerType] || 0) + count;
            productDetails[product].repairTypes[repairType] = 
                (productDetails[product].repairTypes[repairType] || 0) + count;
        });
        
        const top8Products = Object.entries(productDetails)
            .sort((a, b) => b[1].totalCount - a[1].totalCount)
            .slice(0, 8);
        
        let html = '';
        
        top8Products.forEach(([product, data]) => {
            const sortedCenters = Object.entries(data.centerTypes).sort((a, b) => b[1] - a[1]);
            let centerHtml = '';
            sortedCenters.forEach(([centerType, centerCount]) => {
                const centerPercent = data.totalCount > 0 ? (centerCount / data.totalCount * 100).toFixed(1) : 0;
                centerHtml += `
                    <div class="repair-item">
                        <span class="sub-stat-label">${centerType}</span>
                        <span>
                            <span class="sub-stat-value">${centerCount.toLocaleString()}Í±¥</span>
                            <span class="sub-stat-percent">${centerPercent}%</span>
                        </span>
                    </div>
                `;
            });
            
            const sortedRepairs = Object.entries(data.repairTypes)
                .sort((a, b) => {
                    if (a[0] === 'Ï∑®ÏÜå') return 1;
                    if (b[0] === 'Ï∑®ÏÜå') return -1;
                    return b[1] - a[1];
                });
            
            let repairHtml = '';
            sortedRepairs.forEach(([repairType, repairCount]) => {
                const repairPercent = data.totalCount > 0 ? (repairCount / data.totalCount * 100).toFixed(1) : 0;
                repairHtml += `
                    <div class="repair-item">
                        <span class="sub-stat-label">${repairType}</span>
                        <span>
                            <span class="sub-stat-value">${repairCount.toLocaleString()}Í±¥</span>
                            <span class="sub-stat-percent">${repairPercent}%</span>
                        </span>
                    </div>
                `;
            });
            
            html += `
                <div class="product-stat-card">
                    <h3>
                        <span>${product}</span>
                        <span class="total-count">${data.totalCount.toLocaleString()}Í±¥</span>
                    </h3>
                    <div class="sub-stats">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #28a745;">ÏÑºÌÑ∞Ïú†ÌòïÎ≥Ñ Í±¥Ïàò</div>
                        <div class="repair-breakdown">${centerHtml}</div>
                    </div>
                    <div class="sub-stats">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #28a745;">ÏàòÎ¶¨Ïú†ÌòïÎ≥Ñ Í±¥Ïàò</div>
                        <div class="repair-breakdown">${repairHtml}</div>
                    </div>
                </div>
            `;
        });
        
        productStatsGrid.innerHTML = html;
    }
    
    function toggleChart(chartId) {
        const container = document.getElementById(chartId + 'Container');
        const btn = container.previousElementSibling.querySelector('.toggle-btn');
        
        if (container.classList.contains('hidden')) {
            container.classList.remove('hidden');
            btn.textContent = 'Ï∞®Ìä∏ Ïà®Í∏∞Í∏∞';
        } else {
            container.classList.add('hidden');
            btn.textContent = 'Ï∞®Ìä∏ Î≥¥Í∏∞';
        }
    }
    
    function togglePaymentCharts() {
        const container = document.getElementById('paymentChartsContainer');
        const btn = container.previousElementSibling.querySelector('.toggle-btn');
        
        if (container.style.display === 'none') {
            container.style.display = 'block';
            btn.textContent = 'Ï∞®Ìä∏ Ïà®Í∏∞Í∏∞';
        } else {
            container.style.display = 'none';
            btn.textContent = 'Ï∞®Ìä∏ Î≥¥Í∏∞';
        }
    }
    
    // ====================================================================
    // Ï¥àÍ∏∞Ìôî - Í∏∞Ï°¥ decompressData() ÎåÄÏ≤¥
    // ====================================================================
    window.addEventListener('load', async function() {
        var manifest = await DataLoader.loadManifest();
        
        if (!manifest && DataLoader.isLocal) {
            try {
                var cached = localStorage.getItem(DataLoader._storagePrefix + 'manifest');
                if (cached) {
                    DataLoader.manifest = JSON.parse(cached);
                    manifest = DataLoader.manifest;
                    document.getElementById('fbManifestBtn').classList.add('loaded');
                    document.getElementById('fbManifestBtn').textContent = '‚úÖ Ï∫êÏãú Î°úÎìúÎê®';
                    document.getElementById('fbManifestStatus').textContent = manifest.periods.length + 'Í∞ú Í∏∞Í∞Ñ (Ï∫êÏãú)';
                    document.getElementById('fbDataRow').style.display = 'flex';
                }
            } catch(x) {}
        }
        
        if (!manifest) return;
        
        DataLoader.populatePeriodSelector();
        
        var selector = document.getElementById('periodSelector');
        if (selector.options.length > 0) {
            if (DataLoader.isLocal) {
                var periodId = selector.value;
                var cacheKey = periodId + '_' + DataLoader.dataType;
                // IndexedDBÏóêÏÑú ÎåÄÏö©Îüâ Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
                try {
                    var cachedData = await DataLoader.loadFromIDB(cacheKey);
                    if (cachedData) {
                        DataLoader.cache[cacheKey] = cachedData;
                        document.getElementById('fbDataBtn').classList.add('loaded');
                        document.getElementById('fbDataBtn').textContent = '‚úÖ Ï∫êÏãú Î°úÎìúÎê®';
                        document.getElementById('fbDataStatus').textContent = 'Ï∫êÏãúÎêú Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© Ï§ë (IndexedDB)';
                        console.log('[Ï∫êÏãú] IndexedDBÏóêÏÑú Î≥µÏõê: ' + cacheKey);
                    }
                } catch(x) {
                    console.warn('[Ï∫êÏãú] IndexedDB Î≥µÏõê Ïã§Ìå®:', x);
                }
            }
            await changePeriod(selector.value);
        }
        
        selector.addEventListener('change', function() {
            changePeriod(this.value);
        });
    });
    </script>
</body>
</html>
