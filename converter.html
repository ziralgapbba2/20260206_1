<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë³€í™˜ ë„êµ¬</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif;
            background: #0F172A;
            min-height: 100vh;
            color: #E2E8F0;
        }
        
        .app-header {
            background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
            border-bottom: 1px solid #334155;
            padding: 20px 40px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .app-header h1 {
            font-size: 22px;
            font-weight: 800;
            background: linear-gradient(135deg, #60A5FA, #A78BFA);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .app-header .badge {
            font-size: 11px;
            background: #1E3A5F;
            color: #60A5FA;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
        }
        
        /* ìŠ¤í… í‘œì‹œ */
        .steps-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
        }
        .step-item {
            flex: 1;
            padding: 14px 16px;
            background: #1E293B;
            border: 1px solid #334155;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            color: #64748B;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        .step-item.active {
            background: #1E3A5F;
            border-color: #3B82F6;
            color: #93C5FD;
        }
        .step-item.done {
            background: #064E3B;
            border-color: #059669;
            color: #6EE7B7;
        }
        .step-num {
            width: 28px; height: 28px;
            border-radius: 50%;
            background: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 13px;
        }
        .step-item.active .step-num { background: #3B82F6; color: white; }
        .step-item.done .step-num { background: #059669; color: white; }
        
        /* ì¹´ë“œ */
        .card {
            background: #1E293B;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
        }
        .card h2 {
            font-size: 20px;
            font-weight: 700;
            color: #F1F5F9;
            margin-bottom: 8px;
        }
        .card .desc {
            font-size: 14px;
            color: #94A3B8;
            margin-bottom: 24px;
        }
        
        /* ëŒ€ì‹œë³´ë“œ íƒ€ì… ì„ íƒ */
        .type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        .type-card {
            padding: 24px;
            border: 2px solid #334155;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .type-card:hover { border-color: #60A5FA; background: #1E3A5F30; }
        .type-card.selected { border-color: #3B82F6; background: #1E3A5F; }
        .type-card .icon { font-size: 36px; margin-bottom: 12px; }
        .type-card .name { font-size: 16px; font-weight: 700; color: #F1F5F9; margin-bottom: 4px; }
        .type-card .sub { font-size: 12px; color: #94A3B8; }
        
        /* íŒŒì¼ ë“œë¡­ì¡´ */
        .drop-zone {
            border: 2px dashed #475569;
            border-radius: 16px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #0F172A;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #3B82F6;
            background: #1E3A5F20;
        }
        .drop-zone .icon { font-size: 48px; margin-bottom: 16px; }
        .drop-zone .title { font-size: 18px; font-weight: 700; color: #CBD5E1; margin-bottom: 8px; }
        .drop-zone .sub { font-size: 13px; color: #64748B; }
        .drop-zone input { display: none; }
        
        .file-info {
            display: none;
            padding: 16px 20px;
            background: #064E3B;
            border: 1px solid #059669;
            border-radius: 10px;
            margin-top: 16px;
            font-size: 14px;
            color: #6EE7B7;
            font-weight: 600;
        }
        .file-info.show { display: flex; align-items: center; gap: 12px; }
        
        /* ì»¬ëŸ¼ ë§¤í•‘ */
        .mapping-section { display: none; }
        .mapping-section.show { display: block; }
        
        .mapping-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .mapping-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #0F172A;
            border-radius: 10px;
            border: 1px solid #334155;
        }
        .mapping-label {
            min-width: 140px;
            font-size: 13px;
            font-weight: 600;
            color: #94A3B8;
        }
        .mapping-label .required { color: #F87171; }
        .mapping-row select {
            flex: 1;
            padding: 8px 12px;
            background: #1E293B;
            border: 1px solid #475569;
            border-radius: 8px;
            color: #E2E8F0;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
        }
        .mapping-row select:focus { outline: none; border-color: #3B82F6; }
        
        /* ê¸°ê°„ ì…ë ¥ */
        .period-input-group {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 16px;
            background: #0F172A;
            border-radius: 10px;
            border: 1px solid #334155;
        }
        .period-input-group label {
            font-size: 14px;
            font-weight: 600;
            color: #94A3B8;
            min-width: 80px;
        }
        .period-input-group input, .period-input-group select {
            padding: 10px 14px;
            background: #1E293B;
            border: 1px solid #475569;
            border-radius: 8px;
            color: #E2E8F0;
            font-size: 14px;
            font-family: inherit;
        }
        .period-input-group input:focus { outline: none; border-color: #3B82F6; }
        
        /* ë¯¸ë¦¬ë³´ê¸° */
        .preview-box {
            background: #0F172A;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            color: #94A3B8;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .excel-preview {
            overflow-x: auto;
            margin-top: 16px;
        }
        .excel-preview table {
            border-collapse: collapse;
            font-size: 12px;
            width: 100%;
        }
        .excel-preview th {
            background: #334155;
            color: #93C5FD;
            padding: 8px 12px;
            font-weight: 600;
            text-align: left;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }
        .excel-preview td {
            padding: 6px 12px;
            border-bottom: 1px solid #1E293B;
            color: #CBD5E1;
            white-space: nowrap;
        }
        .excel-preview tr:hover td { background: #1E293B; }
        
        /* ë²„íŠ¼ */
        .btn {
            padding: 12px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3B82F6, #6366F1);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(59,130,246,0.3); }
        .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-success {
            background: linear-gradient(135deg, #059669, #10B981);
            color: white;
        }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(5,150,105,0.3); }
        .btn-outline {
            background: transparent;
            border: 2px solid #475569;
            color: #94A3B8;
        }
        .btn-outline:hover { border-color: #60A5FA; color: #60A5FA; }
        
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        /* ê²°ê³¼ */
        .result-section { display: none; }
        .result-section.show { display: block; }
        
        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        .result-stat {
            padding: 16px;
            background: #0F172A;
            border-radius: 10px;
            border: 1px solid #334155;
            text-align: center;
        }
        .result-stat .label { font-size: 12px; color: #64748B; margin-bottom: 4px; }
        .result-stat .value { font-size: 24px; font-weight: 800; color: #60A5FA; }
        
        .download-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .download-card {
            padding: 24px;
            background: #0F172A;
            border: 1px solid #334155;
            border-radius: 12px;
        }
        .download-card h3 {
            font-size: 15px;
            font-weight: 700;
            color: #F1F5F9;
            margin-bottom: 8px;
        }
        .download-card p {
            font-size: 12px;
            color: #64748B;
            margin-bottom: 16px;
        }

        /* ê°€ì´ë“œ ì„¹ì…˜ */
        .guide-section {
            margin-top: 32px;
        }
        .guide-box {
            padding: 20px 24px;
            background: #1E293B;
            border: 1px solid #334155;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        .guide-box h3 {
            font-size: 15px;
            font-weight: 700;
            color: #FBBF24;
            margin-bottom: 12px;
        }
        .guide-box p, .guide-box li {
            font-size: 13px;
            color: #94A3B8;
            line-height: 1.8;
        }
        .guide-box ol, .guide-box ul {
            padding-left: 20px;
        }
        .guide-box code {
            background: #0F172A;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #60A5FA;
            font-family: 'Consolas', monospace;
        }
        .guide-box .file-path {
            display: inline-block;
            background: #064E3B;
            color: #6EE7B7;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Consolas', monospace;
        }
        
        .tab-row {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            background: #0F172A;
            padding: 4px;
            border-radius: 10px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #64748B;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: #334155;
            color: #F1F5F9;
        }
        .tab-btn:hover:not(.active) { color: #94A3B8; }
        
        @media (max-width: 768px) {
            .type-grid { grid-template-columns: 1fr; }
            .mapping-grid { grid-template-columns: 1fr; }
            .download-cards { grid-template-columns: 1fr; }
            .steps-bar { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="app-header">
    <h1>ğŸ”§ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë³€í™˜ ë„êµ¬</h1>
    <span class="badge">v2.0 â€” íŒŒì´ì¬ ë¶ˆí•„ìš”</span>
</div>

<div class="main-container">
    <!-- ìŠ¤í… -->
    <div class="steps-bar">
        <div class="step-item active" id="step1Indicator">
            <span class="step-num">1</span>
            ëŒ€ì‹œë³´ë“œ ìœ í˜• ì„ íƒ
        </div>
        <div class="step-item" id="step2Indicator">
            <span class="step-num">2</span>
            ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ
        </div>
        <div class="step-item" id="step3Indicator">
            <span class="step-num">3</span>
            ì»¬ëŸ¼ ë§¤í•‘ & ë³€í™˜
        </div>
        <div class="step-item" id="step4Indicator">
            <span class="step-num">4</span>
            ë‹¤ìš´ë¡œë“œ & ì ìš©
        </div>
    </div>

    <!-- Step 1: ìœ í˜• ì„ íƒ -->
    <div class="card" id="step1Card">
        <h2>ì–´ë–¤ ëŒ€ì‹œë³´ë“œì— ì‚¬ìš©í•  ë°ì´í„°ì¸ê°€ìš”?</h2>
        <p class="desc">ë³€í™˜í•  ëŒ€ì‹œë³´ë“œ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”. ê° ìœ í˜•ì— ë§ëŠ” JSON êµ¬ì¡°ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.</p>
        <div class="type-grid">
            <div class="type-card" data-type="reception" onclick="selectType('reception')">
                <div class="icon">ğŸ“Š</div>
                <div class="name">ì„œë¹„ìŠ¤ ì ‘ìˆ˜ ë¹„êµ ë¶„ì„</div>
                <div class="sub">index.html</div>
            </div>
            <div class="type-card" data-type="symptom" onclick="selectType('symptom')">
                <div class="icon">ğŸ”</div>
                <div class="name">ë¬¸ì˜ë‚´ìš© ì¦ìƒ ë¶„ì„</div>
                <div class="sub">symptom_analysis.html</div>
            </div>
            <div class="type-card" data-type="processing" onclick="selectType('processing')">
                <div class="icon">ğŸ“‹</div>
                <div class="name">ì²˜ë¦¬ê±´ ë¶„ì„</div>
                <div class="sub">processing_dashboard.html</div>
            </div>
        </div>
    </div>

    <!-- Step 2: íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="card" id="step2Card" style="display:none;">
        <h2>ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</h2>
        <p class="desc">xlsx, xls, csv íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”. ëª¨ë“  ì²˜ë¦¬ëŠ” ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì´ë£¨ì–´ì§€ë©° ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        
        <div class="drop-zone" id="dropZone">
            <div class="icon">ğŸ“</div>
            <div class="title">íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”</div>
            <div class="sub">ë˜ëŠ” í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ (.xlsx, .xls, .csv)</div>
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
        </div>
        
        <div class="file-info" id="fileInfo">
            <span>âœ…</span>
            <span id="fileInfoText"></span>
        </div>
        
        <div id="excelPreviewWrapper" style="display:none; margin-top: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="font-size: 15px; color: #F1F5F9;">ğŸ“‹ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ìƒìœ„ 10í–‰)</h3>
                <span style="font-size: 12px; color: #64748B;" id="sheetSelector"></span>
            </div>
            <div class="excel-preview" id="excelPreview" style="max-height: 300px; overflow: auto;"></div>
        </div>
    </div>

    <!-- Step 3: ë§¤í•‘ -->
    <div class="card mapping-section" id="step3Card">
        <h2>ì»¬ëŸ¼ ë§¤í•‘ ì„¤ì •</h2>
        <p class="desc">ì—‘ì…€ì˜ ì»¬ëŸ¼ì„ ëŒ€ì‹œë³´ë“œ í•„ë“œì— ì—°ê²°í•˜ì„¸ìš”. <span style="color:#F87171;">*</span> í‘œì‹œëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.</p>
        
        <div class="period-input-group">
            <label>ğŸ“… ê¸°ê°„ ID:</label>
            <input type="text" id="periodId" placeholder="ì˜ˆ: 2026-01" style="width: 140px;">
            <label>ë¼ë²¨:</label>
            <input type="text" id="periodLabel" placeholder="ì˜ˆ: 2026ë…„ 1ì›”" style="width: 200px;">
        </div>
        
        <div class="mapping-grid" id="mappingGrid"></div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="convertData()" id="convertBtn">
                ğŸ”„ ë³€í™˜ ì‹¤í–‰
            </button>
            <button class="btn btn-outline" onclick="resetAll()">â†©ï¸ ì²˜ìŒìœ¼ë¡œ</button>
        </div>
    </div>

    <!-- Step 4: ê²°ê³¼ -->
    <div class="card result-section" id="step4Card">
        <h2>âœ… ë³€í™˜ ì™„ë£Œ!</h2>
        <p class="desc">ì•„ë˜ íŒŒì¼ë“¤ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ëŒ€ì‹œë³´ë“œ í´ë”ì— ë„£ìœ¼ì„¸ìš”.</p>
        
        <div class="result-stats" id="resultStats"></div>
        
        <div class="download-cards">
            <div class="download-card">
                <h3>ğŸ“„ ë°ì´í„° JSON</h3>
                <p id="dataFileName">data/2026-01-xxx.json</p>
                <button class="btn btn-success" onclick="downloadDataJson()">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button>
            </div>
            <div class="download-card">
                <h3>ğŸ“‹ manifest.json</h3>
                <p>ê¸°ì¡´ manifest.jsonì— ìƒˆ ê¸°ê°„ì„ ì¶”ê°€í•œ ë²„ì „</p>
                <button class="btn btn-success" onclick="downloadManifest()">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>
        
        <div style="margin-top: 24px;">
            <div class="tab-row">
                <button class="tab-btn active" onclick="showPreviewTab('data')">ë°ì´í„° JSON ë¯¸ë¦¬ë³´ê¸°</button>
                <button class="tab-btn" onclick="showPreviewTab('manifest')">manifest.json ë¯¸ë¦¬ë³´ê¸°</button>
            </div>
            <div class="preview-box" id="jsonPreview" style="max-height: 500px;"></div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="resetAll()">ğŸ”„ ë‹¤ë¥¸ íŒŒì¼ ë³€í™˜</button>
        </div>
    </div>
    
    <!-- ===== ì ìš© ê°€ì´ë“œ ===== -->
    <div class="guide-section">
        <div class="card">
            <h2>ğŸ“– ë°ì´í„° ì ìš© ê°€ì´ë“œ</h2>
            <p class="desc">ë³€í™˜ëœ JSON íŒŒì¼ì„ ëŒ€ì‹œë³´ë“œì— ì ìš©í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.</p>
            
            <div class="guide-box">
                <h3>ğŸ“ Step 1: íŒŒì¼ ë°°ì¹˜</h3>
                <p>ë‹¤ìš´ë¡œë“œ ë°›ì€ íŒŒì¼ì„ ì•„ë˜ êµ¬ì¡°ë¡œ ë°°ì¹˜í•˜ì„¸ìš”:</p>
<pre style="background:#0F172A; padding:16px; border-radius:8px; margin-top:12px; font-size:12px; color:#94A3B8; line-height:1.8;">
ğŸ“ dashboard/
â”œâ”€â”€ index.html                    â† ì„œë¹„ìŠ¤ ì ‘ìˆ˜ ë¹„êµ ë¶„ì„
â”œâ”€â”€ symptom_analysis.html         â† ë¬¸ì˜ë‚´ìš© ì¦ìƒ ë¶„ì„
â”œâ”€â”€ processing_dashboard.html     â† ì²˜ë¦¬ê±´ ë¶„ì„
â”œâ”€â”€ converter.html                â† ì´ ë³€í™˜ ë„êµ¬
â”œâ”€â”€ chart.umd.js                  â† Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬
â”œâ”€â”€ <span style="color:#FBBF24;">manifest.json</span>                 â† ğŸ“Œ ê¸°ê°„ ëª©ë¡ (ë‹¤ìš´ë¡œë“œ êµì²´)
â””â”€â”€ ğŸ“ data/
    â”œâ”€â”€ <span style="color:#6EE7B7;">2026-01-reception.json</span>    â† ì ‘ìˆ˜ ë°ì´í„°
    â”œâ”€â”€ <span style="color:#6EE7B7;">2026-01-symptom.json</span>      â† ì¦ìƒ ë°ì´í„°
    â”œâ”€â”€ <span style="color:#6EE7B7;">2026-01-processing.json</span>   â† ì²˜ë¦¬ ë°ì´í„°
    â”œâ”€â”€ 2026-02-reception.json    â† ë§¤ì›” ì¶”ê°€
    â””â”€â”€ ...
</pre>
            </div>
            
            <div class="guide-box">
                <h3>ğŸ“Œ Step 2: manifest.json êµì²´</h3>
                <p>ë‹¤ìš´ë¡œë“œ ë°›ì€ <code>manifest.json</code>ìœ¼ë¡œ ê¸°ì¡´ íŒŒì¼ì„ <strong>êµì²´(ë®ì–´ì“°ê¸°)</strong>í•˜ì„¸ìš”.</p>
                <p style="margin-top:8px;">manifest.jsonì€ ëª¨ë“  ëŒ€ì‹œë³´ë“œê°€ ê³µìœ í•˜ëŠ” ê¸°ê°„ ëª©ë¡ì…ë‹ˆë‹¤. ë³€í™˜í•  ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ ìƒˆ ê¸°ê°„ì´ ì¶”ê°€ë©ë‹ˆë‹¤.</p>
                <p style="margin-top:8px; color:#F87171;">âš ï¸ ê¸°ì¡´ manifest.jsonì´ ìˆë‹¤ë©´, ë³€í™˜ ì „ì— ì´ ë„êµ¬ì˜ "manifest ë¶ˆëŸ¬ì˜¤ê¸°" ê¸°ëŠ¥ìœ¼ë¡œ ë¨¼ì € ë¡œë“œí•˜ì„¸ìš”.</p>
            </div>
            
            <div class="guide-box">
                <h3>ğŸ”„ Step 3: ë°ì´í„° JSON ë³µì‚¬</h3>
                <p>ë‹¤ìš´ë¡œë“œ ë°›ì€ ë°ì´í„° JSONì„ <code>data/</code> í´ë”ì— ë„£ìœ¼ì„¸ìš”.</p>
                <ul style="margin-top:8px;">
                    <li>ì ‘ìˆ˜ ë¶„ì„: <span class="file-path">data/2026-01-reception.json</span></li>
                    <li>ì¦ìƒ ë¶„ì„: <span class="file-path">data/2026-01-symptom.json</span></li>
                    <li>ì²˜ë¦¬ ë¶„ì„: <span class="file-path">data/2026-01-processing.json</span></li>
                </ul>
            </div>
            
            <div class="guide-box">
                <h3>âœ… Step 4: í™•ì¸</h3>
                <p>ë¸Œë¼ìš°ì €ì—ì„œ HTML íŒŒì¼ì„ ì—´ê³  ê¸°ê°„ ì„ íƒ ë“œë¡­ë‹¤ìš´ì—ì„œ ìƒˆ ê¸°ê°„ì´ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</p>
                <p style="margin-top:8px;">GitHub Pages ë°°í¬ ì‹œ: <code>git add . && git commit -m "2026-02 ë°ì´í„° ì¶”ê°€" && git push</code></p>
            </div>
            
            <div class="guide-box">
                <h3>ğŸ’¡ ë§¤ì›” ì—…ë°ì´íŠ¸ ì›Œí¬í”Œë¡œìš°</h3>
                <ol>
                    <li>ì´ ë„êµ¬(<code>converter.html</code>)ë¥¼ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ê¸°</li>
                    <li>ëŒ€ì‹œë³´ë“œ ìœ í˜• ì„ íƒ (ì ‘ìˆ˜/ì¦ìƒ/ì²˜ë¦¬)</li>
                    <li>ìƒˆ ë‹¬ì˜ ì—‘ì…€ íŒŒì¼ ë“œë˜ê·¸ & ë“œë¡­</li>
                    <li>ì»¬ëŸ¼ ë§¤í•‘ í™•ì¸ â†’ "ë³€í™˜ ì‹¤í–‰"</li>
                    <li>ë°ì´í„° JSON + manifest.json ë‹¤ìš´ë¡œë“œ</li>
                    <li><code>data/</code> í´ë”ì— JSON ë³µì‚¬, manifest.json êµì²´</li>
                    <li>3ê°œ ëŒ€ì‹œë³´ë“œ ìœ í˜•ì— ëŒ€í•´ ë°˜ë³µ</li>
                </ol>
            </div>
            
            <div class="guide-box">
                <h3>ğŸ”§ ê¸°ì¡´ HTMLì—ì„œ ë°ì´í„° ì¶”ì¶œí•˜ê¸° (ìµœì´ˆ 1íšŒ)</h3>
                <p>ì´ë¯¸ ë™ì‘í•˜ëŠ” ê¸°ì¡´ HTMLì´ ìˆë‹¤ë©´ ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ë°ì´í„°ë¥¼ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:</p>
<pre style="background:#0F172A; padding:16px; border-radius:8px; margin-top:12px; font-size:12px; color:#94A3B8; line-height:2;">
<span style="color:#FBBF24;">// index.html (ì ‘ìˆ˜ ë¹„êµ ë¶„ì„)</span>
copy(JSON.stringify(DASHBOARD_DATA))
â†’ ë¶™ì—¬ë„£ê¸° í›„ <span class="file-path">data/2026-01-reception.json</span>ìœ¼ë¡œ ì €ì¥

<span style="color:#FBBF24;">// symptom_analysis.html (ì¦ìƒ ë¶„ì„)</span>
copy(JSON.stringify({meta:{period:"2026-01",totalRecords:78036},products:Object.keys(data),data:data}))
â†’ ë¶™ì—¬ë„£ê¸° í›„ <span class="file-path">data/2026-01-symptom.json</span>ìœ¼ë¡œ ì €ì¥

<span style="color:#FBBF24;">// processing_dashboard.html (ì²˜ë¦¬ê±´ ë¶„ì„)</span>
<span style="color:#64748B;">// â€» í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„ ì‹¤í–‰ (rawDataê°€ ì±„ì›Œì§„ í›„)</span>
copy(JSON.stringify({meta:{period:"2026-01"},rows:rawData}))
â†’ ë¶™ì—¬ë„£ê¸° í›„ <span class="file-path">data/2026-01-processing.json</span>ìœ¼ë¡œ ì €ì¥
</pre>
            </div>
        </div>
    </div>
</div>

<script>
// ====================================================================
// ìƒíƒœ ê´€ë¦¬
// ====================================================================
let selectedType = null;
let workbook = null;
let sheetData = [];
let columns = [];
let convertedData = null;
let convertedManifest = null;

// í˜„ì¬ manifest (ê¸°ì¡´ ê²ƒ ë¶ˆëŸ¬ì˜¤ê¸° ê°€ëŠ¥)
let currentManifest = {
    version: "2.0",
    dashboard_types: {
        reception: "ì„œë¹„ìŠ¤ ì ‘ìˆ˜ ë¹„êµ ë¶„ì„",
        symptom: "ë¬¸ì˜ë‚´ìš© ì¦ìƒ ë¶„ì„",
        processing: "ì²˜ë¦¬ê±´ ë¶„ì„"
    },
    periods: []
};

// ê° ëŒ€ì‹œë³´ë“œ ìœ í˜•ë³„ í•„ìš” ì»¬ëŸ¼
const COLUMN_DEFS = {
    reception: [
        { id: 'date', label: 'ì ‘ìˆ˜ì¼ì', required: true, hint: 'ë‚ ì§œ ì»¬ëŸ¼' },
        { id: 'centerType1', label: 'ì„¼í„°êµ¬ë¶„', required: true, hint: 'ì„¤ì¹˜ë²•ì¸/ìŠ¤í† ì–´ ë“±' },
        { id: 'centerType2', label: 'ì„¼í„°êµ¬ë¶„2', required: false, hint: 'ì„¸ë¶€ ì„¼í„° ìœ í˜•' },
        { id: 'centerName', label: 'ì„¼í„°ëª…', required: true, hint: 'ì„¼í„° ì´ë¦„' },
        { id: 'payment', label: 'ìœ ë¬´ìƒì²˜ë¦¬', required: false, hint: 'Y/N/ë¯¸ì²˜ë¦¬' },
        { id: 'product', label: 'ì œí’ˆëª…', required: true, hint: 'ì œí’ˆ ì´ë¦„' },
        { id: 'service', label: 'ì„œë¹„ìŠ¤êµ¬ë¶„', required: false, hint: 'ì„œë¹„ìŠ¤ ìœ í˜•' },
        { id: 'fault', label: 'ê³ ì¥ë‚´ìš©ì†Œë¶„ë¥˜', required: false, hint: 'ê³ ì¥ ìƒì„¸ ë¶„ë¥˜' },
    ],
    symptom: [
        { id: 'product', label: 'ì œí’ˆëª…', required: true, hint: 'ì œí’ˆ ì´ë¦„' },
        { id: 'symptom', label: 'ì¦ìƒ/ë¬¸ì˜ë‚´ìš©', required: true, hint: 'ì¦ìƒ í…ìŠ¤íŠ¸' },
    ],
    processing: [
        { id: 'product', label: 'ì œí’ˆëª…', required: true, hint: '' },
        { id: 'centerType1', label: 'ì„¼í„°êµ¬ë¶„', required: false, hint: '' },
        { id: 'centerType2', label: 'ì„¼í„°êµ¬ë¶„2', required: false, hint: '' },
        { id: 'repair', label: 'ìˆ˜ë¦¬', required: false, hint: 'ìˆ˜ë¦¬ìœ í˜•' },
        { id: 'processType', label: 'ì²˜ë¦¬êµ¬ë¶„', required: false, hint: '' },
        { id: 'payment', label: 'ìœ ë¬´ìƒêµ¬ë¶„', required: false, hint: 'Y/N' },
        { id: 'processMonth', label: 'ì²˜ë¦¬ì›”', required: false, hint: '2026-01 í˜•íƒœ' },
        { id: 'center', label: 'ì´ê´€ì²˜', required: false, hint: 'ì„¼í„°ëª…' },
        { id: 'count', label: 'ê±´ìˆ˜', required: false, hint: 'ìˆ«ì (ì—†ìœ¼ë©´ 1ê±´ì”© ì¹´ìš´íŠ¸)' },
    ]
};

// ìë™ ë§¤í•‘ íŒíŠ¸
const AUTO_MAP_HINTS = {
    'date': ['ì ‘ìˆ˜ì¼ì', 'ì ‘ìˆ˜ì¼', 'ì¼ì', 'ë‚ ì§œ', 'date'],
    'centerType1': ['ì„¼í„°êµ¬ë¶„', 'ì„¼í„°ìœ í˜•'],
    'centerType2': ['ì„¼í„°êµ¬ë¶„2', 'ì„¼í„°ìœ í˜•ìƒì„¸', 'ì„¼í„°ìœ í˜•2'],
    'centerName': ['ì„¼í„°ëª…', 'ì„¼í„°ì´ë¦„', 'ì´ê´€ì²˜'],
    'payment': ['ìœ ë¬´ìƒì²˜ë¦¬', 'ìœ ë¬´ìƒêµ¬ë¶„', 'ìœ ë¬´ìƒ'],
    'product': ['ì œí’ˆëª…', 'ì œí’ˆ', 'í’ˆëª…', 'ì œí’ˆêµ°'],
    'service': ['ì„œë¹„ìŠ¤êµ¬ë¶„', 'ì„œë¹„ìŠ¤ìœ í˜•', 'ì„œë¹„ìŠ¤'],
    'fault': ['ê³ ì¥ë‚´ìš©ì†Œë¶„ë¥˜', 'ê³ ì¥ë‚´ìš©', 'ê³ ì¥ë¶„ë¥˜', 'ë¶ˆëŸ‰ë‚´ìš©'],
    'symptom': ['ì¦ìƒ', 'ë¬¸ì˜ë‚´ìš©', 'ê³ ì¥ì¦ìƒ', 'ì ‘ìˆ˜ë‚´ìš©', 'ë‚´ìš©'],
    'repair': ['ìˆ˜ë¦¬', 'ìˆ˜ë¦¬ìœ í˜•', 'ìˆ˜ë¦¬êµ¬ë¶„'],
    'processType': ['ì²˜ë¦¬êµ¬ë¶„', 'ì²˜ë¦¬ìœ í˜•'],
    'processMonth': ['ì²˜ë¦¬ì›”', 'ì²˜ë¦¬ë…„ì›”'],
    'center': ['ì´ê´€ì²˜', 'ì²˜ë¦¬ì„¼í„°', 'ì„¼í„°ëª…'],
    'count': ['ê±´ìˆ˜', 'ìˆ˜ëŸ‰', 'count'],
};

// ====================================================================
// Step 1: ìœ í˜• ì„ íƒ
// ====================================================================
function selectType(type) {
    selectedType = type;
    document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
    document.querySelector(`.type-card[data-type="${type}"]`).classList.add('selected');
    
    updateStep(1, 'done');
    updateStep(2, 'active');
    document.getElementById('step2Card').style.display = 'block';
    document.getElementById('step2Card').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ====================================================================
// Step 2: íŒŒì¼ ì—…ë¡œë“œ
// ====================================================================
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length) handleFile(e.target.files[0]);
});

function handleFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            workbook = XLSX.read(data, { type: 'array', cellDates: true });
            
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            sheetData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
            
            if (sheetData.length === 0) {
                alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            columns = Object.keys(sheetData[0]);
            
            // íŒŒì¼ ì •ë³´ í‘œì‹œ
            const info = document.getElementById('fileInfo');
            document.getElementById('fileInfoText').textContent = 
                `${file.name} â€” ${sheetData.length.toLocaleString()}í–‰ Ã— ${columns.length}ì—´ (ì‹œíŠ¸: ${sheetName})`;
            info.classList.add('show');
            
            // ì‹œíŠ¸ ì„ íƒê¸° (ì—¬ëŸ¬ ì‹œíŠ¸ì¸ ê²½ìš°)
            if (workbook.SheetNames.length > 1) {
                let html = '<select onchange="changeSheet(this.value)" style="background:#1E293B;border:1px solid #475569;border-radius:6px;padding:4px 8px;color:#E2E8F0;font-size:12px;">';
                workbook.SheetNames.forEach(name => {
                    html += `<option value="${name}">${name}</option>`;
                });
                html += '</select>';
                document.getElementById('sheetSelector').innerHTML = 'ì‹œíŠ¸: ' + html;
            }
            
            // ë¯¸ë¦¬ë³´ê¸°
            showExcelPreview();
            
            // ë§¤í•‘ ë‹¨ê³„ë¡œ
            showMappingStep();
            
        } catch (err) {
            alert('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + err.message);
            console.error(err);
        }
    };
    reader.readAsArrayBuffer(file);
}

function changeSheet(sheetName) {
    const worksheet = workbook.Sheets[sheetName];
    sheetData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
    columns = sheetData.length > 0 ? Object.keys(sheetData[0]) : [];
    showExcelPreview();
    buildMappingUI();
}

function showExcelPreview() {
    const wrapper = document.getElementById('excelPreviewWrapper');
    const container = document.getElementById('excelPreview');
    wrapper.style.display = 'block';
    
    let html = '<table><thead><tr>';
    columns.forEach(col => { html += `<th>${col}</th>`; });
    html += '</tr></thead><tbody>';
    
    const previewRows = sheetData.slice(0, 10);
    previewRows.forEach(row => {
        html += '<tr>';
        columns.forEach(col => {
            let val = row[col];
            if (val instanceof Date) val = val.toLocaleDateString('ko-KR');
            else if (val === null || val === undefined) val = '';
            html += `<td>${String(val).substring(0, 50)}</td>`;
        });
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

// ====================================================================
// Step 3: ë§¤í•‘
// ====================================================================
function showMappingStep() {
    updateStep(2, 'done');
    updateStep(3, 'active');
    
    const card = document.getElementById('step3Card');
    card.classList.add('show');
    
    // ê¸°ê°„ ìë™ì¶”ì •
    autoDetectPeriod();
    buildMappingUI();
    
    card.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function autoDetectPeriod() {
    // ë‚ ì§œ ì»¬ëŸ¼ì—ì„œ ê¸°ê°„ ì¶”ì •
    const dateCol = columns.find(c => AUTO_MAP_HINTS.date.some(h => c.includes(h)));
    if (dateCol && sheetData.length > 0) {
        const sample = sheetData[Math.floor(sheetData.length / 2)][dateCol];
        if (sample instanceof Date) {
            const y = sample.getFullYear();
            const m = String(sample.getMonth() + 1).padStart(2, '0');
            document.getElementById('periodId').value = `${y}-${m}`;
            document.getElementById('periodLabel').value = `${y}ë…„ ${parseInt(m)}ì›”`;
            return;
        }
    }
    // ì²˜ë¦¬ì›” ì»¬ëŸ¼ì—ì„œ ì¶”ì •
    const monthCol = columns.find(c => c.includes('ì²˜ë¦¬ì›”') || c.includes('ë…„ì›”'));
    if (monthCol && sheetData.length > 0) {
        const vals = [...new Set(sheetData.map(r => r[monthCol]).filter(v => v))].sort();
        if (vals.length > 0) {
            const latest = vals[vals.length - 1];
            document.getElementById('periodId').value = latest;
            document.getElementById('periodLabel').value = latest.replace('-', 'ë…„ ').replace(/(\d+)$/, '$1ì›”');
        }
    }
}

function buildMappingUI() {
    const grid = document.getElementById('mappingGrid');
    const defs = COLUMN_DEFS[selectedType] || [];
    
    grid.innerHTML = defs.map(def => {
        // ìë™ ë§¤ì¹­
        const hints = AUTO_MAP_HINTS[def.id] || [];
        const autoMatch = columns.find(col => hints.some(h => col.toLowerCase().includes(h.toLowerCase())));
        
        let options = `<option value="">â€” ì„ íƒ ì•ˆí•¨ â€”</option>`;
        columns.forEach(col => {
            const selected = (col === autoMatch) ? 'selected' : '';
            options += `<option value="${col}" ${selected}>${col}</option>`;
        });
        
        return `
            <div class="mapping-row">
                <div class="mapping-label">
                    ${def.required ? '<span class="required">*</span> ' : ''}${def.label}
                    ${def.hint ? `<br><span style="font-size:11px;color:#475569;">${def.hint}</span>` : ''}
                </div>
                <select id="map_${def.id}">${options}</select>
            </div>
        `;
    }).join('');
}

// ====================================================================
// ë³€í™˜ ë¡œì§
// ====================================================================
function convertData() {
    const periodId = document.getElementById('periodId').value.trim();
    const periodLabel = document.getElementById('periodLabel').value.trim();
    
    if (!periodId) { alert('ê¸°ê°„ IDë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2026-01)'); return; }
    
    // ë§¤í•‘ ì½ê¸°
    const mapping = {};
    const defs = COLUMN_DEFS[selectedType] || [];
    for (const def of defs) {
        const select = document.getElementById('map_' + def.id);
        if (select) mapping[def.id] = select.value;
        if (def.required && !mapping[def.id]) {
            alert(`í•„ìˆ˜ í•­ëª© "${def.label}"ì˜ ì»¬ëŸ¼ì„ ì„ íƒí•˜ì„¸ìš”.`);
            return;
        }
    }
    
    try {
        if (selectedType === 'reception') {
            convertedData = convertReception(sheetData, mapping, periodId);
        } else if (selectedType === 'symptom') {
            convertedData = convertSymptom(sheetData, mapping, periodId);
        } else if (selectedType === 'processing') {
            convertedData = convertProcessing(sheetData, mapping, periodId);
        }
        
        // manifest ì—…ë°ì´íŠ¸
        const fileName = `data/${periodId}-${selectedType}.json`;
        updateManifest(periodId, periodLabel, selectedType, fileName);
        
        showResult(periodId);
        
    } catch (err) {
        alert('ë³€í™˜ ì˜¤ë¥˜: ' + err.message);
        console.error(err);
    }
}

// --- ì ‘ìˆ˜ ë¹„êµ ë¶„ì„ ---
function convertReception(rows, map, periodId) {
    // ë‚ ì§œ íŒŒì‹±
    const parsed = rows.map(row => {
        let d = row[map.date];
        if (!(d instanceof Date)) d = new Date(d);
        const ym = isNaN(d) ? null : d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
        return { ...row, _ym: ym, _day: d instanceof Date && !isNaN(d) ? d.getDate() : null };
    }).filter(r => r._ym);
    
    // ì›” ëª©ë¡
    const months = [...new Set(parsed.map(r => r._ym))].sort();
    if (months.length < 2) throw new Error('ìµœì†Œ 2ê°œì›” ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤');
    const lastMonth = months[months.length - 2];
    const thisMonth = months[months.length - 1];
    const filtered = parsed.filter(r => r._ym === lastMonth || r._ym === thisMonth);
    
    // í•„í„° ì˜µì…˜
    const filterOpts1 = map.centerType1 ? [...new Set(filtered.map(r => r[map.centerType1]).filter(Boolean))].sort() : [];
    const filterOpts2 = map.centerType2 ? [...new Set(filtered.map(r => r[map.centerType2]).filter(Boolean))].sort() : [];
    
    // ì„¼í„°ëª… â†’ êµ¬ë¶„ ë§¤í•‘
    const locToCenter = {};
    if (map.centerName && map.centerType1) {
        filtered.forEach(r => {
            if (r[map.centerName] && r[map.centerType1]) locToCenter[r[map.centerName]] = r[map.centerType1];
        });
    }
    
    // í•„í„° ì¡°í•© ìƒì„±
    const combos = [['ì „ì²´','ì „ì²´','ì „ì²´']];
    const f1List = ['ì „ì²´', ...filterOpts1];
    const f2List = ['ì „ì²´', ...filterOpts2];
    const f3List = ['ì „ì²´', 'Y', 'N', 'ë¯¸ì²˜ë¦¬'];
    for (const f1 of f1List) for (const f2 of f2List) for (const f3 of f3List) {
        const key = `${f1}|${f2}|${f3}`;
        if (!combos.find(c => c.join('|') === key)) combos.push([f1,f2,f3]);
    }
    
    const aggregated = {};
    for (const [f1,f2,f3] of combos) {
        let subset = filtered;
        if (f1 !== 'ì „ì²´' && map.centerType1) subset = subset.filter(r => r[map.centerType1] === f1);
        if (f2 !== 'ì „ì²´' && map.centerType2) subset = subset.filter(r => r[map.centerType2] === f2);
        if (f3 !== 'ì „ì²´' && map.payment) subset = subset.filter(r => r[map.payment] === f3);
        if (subset.length === 0) continue;
        
        const key = `${f1}|${f2}|${f3}`;
        
        // ì›”ë³„ í†µê³„
        const ms = {};
        [lastMonth, thisMonth].forEach(m => {
            const md = subset.filter(r => r._ym === m);
            const days = new Set(md.map(r => r._day)).size || 1;
            ms[m] = { ì ‘ìˆ˜ê±´ìˆ˜: md.length, ë‹¹ì›”ì²˜ë¦¬ìœ¨: 0, ì¼í‰ê· ì ‘ìˆ˜ê±´: +(md.length/days).toFixed(1) };
        });
        
        // ì¼ìë³„
        const daily = [];
        for (let d = 1; d <= 31; d++) {
            const lc = subset.filter(r => r._ym === lastMonth && r._day === d).length;
            const tc = subset.filter(r => r._ym === thisMonth && r._day === d).length;
            if (lc || tc) daily.push({ day: d+'ì¼', lastMonth: lc, thisMonth: tc });
        }
        
        // ì œí’ˆë³„
        const products = {};
        if (map.product) {
            subset.forEach(r => {
                const p = r[map.product];
                if (!p) return;
                if (!products[p]) products[p] = {lastMonth:0, thisMonth:0};
                products[p][r._ym === lastMonth ? 'lastMonth' : 'thisMonth']++;
            });
        }
        
        // ì„œë¹„ìŠ¤ë³„
        const services = {};
        if (map.service) {
            subset.forEach(r => {
                const s = r[map.service];
                if (!s) return;
                if (!services[s]) services[s] = {lastMonth:0, thisMonth:0};
                services[s][r._ym === lastMonth ? 'lastMonth' : 'thisMonth']++;
            });
        }
        
        // ì„¼í„°ë³„ ìƒì„¸
        const locDetail = {};
        if (map.centerName) {
            subset.forEach(r => {
                const c = r[map.centerName];
                if (!c) return;
                if (!locDetail[c]) locDetail[c] = {lastMonth:0, thisMonth:0, faults:[]};
                locDetail[c][r._ym === lastMonth ? 'lastMonth' : 'thisMonth']++;
            });
            // ê³ ì¥ë‚´ìš©
            if (map.fault) {
                Object.keys(locDetail).forEach(center => {
                    const cd = subset.filter(r => r[map.centerName] === center);
                    const faultMap = {};
                    cd.forEach(r => {
                        const f = r[map.fault]; if (!f) return;
                        if (!faultMap[f]) faultMap[f] = {lastMonth:0,thisMonth:0};
                        faultMap[f][r._ym === lastMonth ? 'lastMonth':'thisMonth']++;
                    });
                    locDetail[center].faults = Object.entries(faultMap)
                        .sort((a,b) => (b[1].lastMonth+b[1].thisMonth) - (a[1].lastMonth+a[1].thisMonth))
                        .slice(0,5)
                        .map(([name,v]) => ({name, lastMonth:v.lastMonth, thisMonth:v.thisMonth}));
                });
            }
        }
        
        // ë¶„ì„
        const analysis = { increase: [], decrease: [] };
        Object.entries(products).forEach(([name, c]) => {
            const change = c.thisMonth - c.lastMonth;
            const rate = c.lastMonth > 0 ? +((change/c.lastMonth)*100).toFixed(1) : (c.thisMonth > 0 ? 100 : 0);
            const item = {name, lastMonth:c.lastMonth, thisMonth:c.thisMonth, change, changeRate:rate, faults:[]};
            if (change > 0) analysis.increase.push(item);
            else if (change < 0) analysis.decrease.push(item);
        });
        analysis.increase.sort((a,b) => b.change - a.change);
        analysis.increase = analysis.increase.slice(0,5);
        analysis.decrease.sort((a,b) => a.change - b.change);
        analysis.decrease = analysis.decrease.slice(0,5);
        
        aggregated[key] = { monthly_stats: ms, daily_chart_data: daily, products, services, locations_detail: locDetail, analysis };
    }
    
    return {
        meta: { period: periodId, lastMonth, thisMonth, generated: new Date().toISOString(), totalRows: filtered.length },
        filter_options: { 'ì„¼í„°êµ¬ë¶„': filterOpts1, 'ì„¼í„°êµ¬ë¶„2': filterOpts2 },
        location_to_center: locToCenter,
        aggregated_data: aggregated
    };
}

// --- ì¦ìƒ ë¶„ì„ ---
function convertSymptom(rows, map, periodId) {
    const productMap = {};
    
    rows.forEach(row => {
        const product = row[map.product];
        const symptom = row[map.symptom];
        if (!product || !symptom) return;
        const sym = String(symptom).trim();
        if (!sym) return;
        
        if (!productMap[product]) productMap[product] = { total: 0, symptoms: {} };
        productMap[product].total++;
        productMap[product].symptoms[sym] = (productMap[product].symptoms[sym] || 0) + 1;
    });
    
    const products = Object.keys(productMap).sort((a,b) => productMap[b].total - productMap[a].total).slice(0, 10);
    
    const data = {};
    products.forEach(p => {
        const pm = productMap[p];
        const sortedSymptoms = Object.entries(pm.symptoms)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 30)
            .map(([symptom, count]) => ({
                symptom,
                count,
                percentage: +((count / pm.total) * 100).toFixed(2)
            }));
        
        data[p] = { total_count: pm.total, symptoms: sortedSymptoms };
    });
    
    return {
        meta: { period: periodId, totalRecords: rows.length, generated: new Date().toISOString() },
        products,
        data
    };
}

// --- ì²˜ë¦¬ê±´ ë¶„ì„ ---
function convertProcessing(rows, map, periodId) {
    const outputRows = rows.map(row => {
        const out = {};
        if (map.product) out['ì œí’ˆëª…'] = row[map.product] || null;
        if (map.centerType1) out['ì„¼í„°êµ¬ë¶„'] = row[map.centerType1] || null;
        if (map.centerType2) out['ì„¼í„°êµ¬ë¶„2'] = row[map.centerType2] || null;
        if (map.repair) out['ìˆ˜ë¦¬'] = row[map.repair] || null;
        if (map.processType) out['ì²˜ë¦¬êµ¬ë¶„'] = row[map.processType] || null;
        if (map.payment) out['ìœ ë¬´ìƒêµ¬ë¶„'] = row[map.payment] || null;
        if (map.processMonth) {
            let pm = row[map.processMonth];
            if (pm instanceof Date) pm = pm.getFullYear()+'-'+String(pm.getMonth()+1).padStart(2,'0');
            out['ì²˜ë¦¬ì›”'] = pm || null;
        }
        if (map.center) out['ì´ê´€ì²˜'] = row[map.center] || null;
        out['ê±´ìˆ˜'] = map.count ? (parseInt(row[map.count]) || 1) : 1;
        return out;
    });
    
    return {
        meta: { period: periodId, generated: new Date().toISOString() },
        rows: outputRows
    };
}

// ====================================================================
// Manifest ê´€ë¦¬
// ====================================================================
function updateManifest(periodId, label, type, fileName) {
    // ê¸°ì¡´ period ì°¾ê¸°
    let period = currentManifest.periods.find(p => p.id === periodId);
    
    if (!period) {
        period = { id: periodId, label: label || periodId, generated: new Date().toISOString().split('T')[0], files: {} };
        currentManifest.periods.push(period);
    }
    
    period.files[type] = fileName;
    period.label = label || period.label;
    period.generated = new Date().toISOString().split('T')[0];
    
    currentManifest.periods.sort((a,b) => a.id.localeCompare(b.id));
    convertedManifest = currentManifest;
}

// ====================================================================
// Step 4: ê²°ê³¼ í‘œì‹œ
// ====================================================================
function showResult(periodId) {
    updateStep(3, 'done');
    updateStep(4, 'active');
    
    const card = document.getElementById('step4Card');
    card.classList.add('show');
    
    // íŒŒì¼ëª…
    const fileName = `data/${periodId}-${selectedType}.json`;
    document.getElementById('dataFileName').textContent = fileName;
    
    // í†µê³„
    const jsonStr = JSON.stringify(convertedData, null, 2);
    const stats = document.getElementById('resultStats');
    let statsHtml = `
        <div class="result-stat"><div class="label">íŒŒì¼ í¬ê¸°</div><div class="value">${formatSize(jsonStr.length)}</div></div>
    `;
    
    if (selectedType === 'reception') {
        statsHtml += `
            <div class="result-stat"><div class="label">ì´ í–‰ìˆ˜</div><div class="value">${convertedData.meta.totalRows?.toLocaleString()}</div></div>
            <div class="result-stat"><div class="label">í•„í„° ì¡°í•©</div><div class="value">${Object.keys(convertedData.aggregated_data).length}</div></div>
            <div class="result-stat"><div class="label">ê¸°ê°„</div><div class="value">${convertedData.meta.lastMonth} ~ ${convertedData.meta.thisMonth}</div></div>
        `;
    } else if (selectedType === 'symptom') {
        statsHtml += `
            <div class="result-stat"><div class="label">ì´ ë ˆì½”ë“œ</div><div class="value">${convertedData.meta.totalRecords?.toLocaleString()}</div></div>
            <div class="result-stat"><div class="label">ì œí’ˆ ìˆ˜</div><div class="value">${convertedData.products.length}</div></div>
        `;
    } else if (selectedType === 'processing') {
        statsHtml += `
            <div class="result-stat"><div class="label">ì´ í–‰ìˆ˜</div><div class="value">${convertedData.rows.length.toLocaleString()}</div></div>
        `;
    }
    
    stats.innerHTML = statsHtml;
    
    // ë¯¸ë¦¬ë³´ê¸°
    document.getElementById('jsonPreview').textContent = jsonStr.substring(0, 10000) + (jsonStr.length > 10000 ? '\n\n... (ì´í•˜ ìƒëµ)' : '');
    
    card.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function showPreviewTab(type) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    
    const preview = document.getElementById('jsonPreview');
    if (type === 'data') {
        const str = JSON.stringify(convertedData, null, 2);
        preview.textContent = str.substring(0, 10000) + (str.length > 10000 ? '\n\n... (ì´í•˜ ìƒëµ)' : '');
    } else {
        preview.textContent = JSON.stringify(convertedManifest, null, 4);
    }
}

// ====================================================================
// ë‹¤ìš´ë¡œë“œ
// ====================================================================
function downloadDataJson() {
    const periodId = document.getElementById('periodId').value.trim();
    const fileName = `${periodId}-${selectedType}.json`;
    downloadJson(convertedData, fileName);
}

function downloadManifest() {
    downloadJson(convertedManifest, 'manifest.json');
}

function downloadJson(data, fileName) {
    const str = JSON.stringify(data, null, 2);
    const blob = new Blob([str], { type: 'application/json;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(url);
}

// ====================================================================
// ìœ í‹¸ë¦¬í‹°
// ====================================================================
function updateStep(num, state) {
    const el = document.getElementById(`step${num}Indicator`);
    el.classList.remove('active', 'done');
    if (state) el.classList.add(state);
}

function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
    return (bytes/(1024*1024)).toFixed(1) + ' MB';
}

function resetAll() {
    selectedType = null;
    workbook = null;
    sheetData = [];
    columns = [];
    convertedData = null;
    
    document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
    document.getElementById('step2Card').style.display = 'none';
    document.getElementById('step3Card').classList.remove('show');
    document.getElementById('step4Card').classList.remove('show');
    document.getElementById('fileInfo').classList.remove('show');
    document.getElementById('excelPreviewWrapper').style.display = 'none';
    document.getElementById('fileInput').value = '';
    
    updateStep(1, 'active');
    updateStep(2, '');
    updateStep(3, '');
    updateStep(4, '');
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>
</body>
</html>
